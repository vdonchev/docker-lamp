services:
  lamp.web:
    container_name: apache-${PHP_VERSION}
    build:
      context: ./bin/${PHP_VERSION}
    ports:
      - ${HTTP_PORT}:80
      - ${HTTPS_PORT}:443
    restart: always
    volumes:
      - ${WEB_HOST}:/var/www
      - ${WEB_STORAGE}:/home/storage
      - ./config/php/php.ini:/usr/local/etc/php/php.ini
      - ./config/apache/vhosts:/etc/apache2/sites-enabled
      - ./config/apache/ssl:/etc/ssl/lamp
      - ./var/log/apache:/var/log/apache2
      - ./var/log/php:/var/log/php
    entrypoint: ["sh", "-c", "chmod 777 -R /var/www && apache2-foreground"]
    depends_on:
      - lamp.db
    networks:
      - lamp
  lamp.db:
    container_name: ${MYSQL_VERSION}
    build:
      context: ./bin/${MYSQL_VERSION}
    ports:
      - ${MYSQL_PORT}:3306
    restart: always
    volumes:
      - ${DB_HOST}:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/custom-configs.cnf
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
    networks:
      - lamp
  # How to start docker with Redis (only when you need it)
  # start command: COMPOSE_PROFILES=redis-enabled docker-compose up -d
  # stop command: COMPOSE_PROFILES=redis-enabled docker-compose down
  lamp.redis:
    container_name: redis
    image: redis
    ports:
      - "6379:6379"
    depends_on:
      - lamp.db
    profiles:
      - redis-enabled
    networks:
      - lamp
  lamp.pma:
    container_name: pma
    image: phpmyadmin/phpmyadmin
    restart: always
    ports:
      - ${PMA_PORT}:80
    environment:
      PMA_HOST: ${MYSQL_VERSION}
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${ROOT_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
    depends_on:
      - lamp.db
    profiles:
      - pma-enabled
    networks:
      - lamp
networks:
  lamp:
    driver: bridge