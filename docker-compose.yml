services:
  lamp.web:
    container_name: apache-${PHP_VERSION:-php84}
    build:
      context: ./bin/${PHP_VERSION:-php84}
    ports:
      - ${HTTP_PORT:-80}:80
      - ${HTTPS_PORT:-443}:443
    restart: always
    volumes:
      - ${WEB_HOST:-./app}:/var/www
      - ${WEB_STORAGE:-./app}:/home/storage
      - ./config/php/php.ini:/usr/local/etc/php/php.ini
      - ./config/apache/vhosts/generated:/etc/apache2/sites-enabled
      - ./config/apache/ssl:/etc/ssl/lamp
      - ./var/log/apache:/var/log/apache2
      - ./scripts:/scripts
      - ./config:/config
      - ./entrypoint.sh:/entrypoint.sh
    entrypoint: ["/entrypoint.sh"]
    depends_on:
      - lamp.db
    networks:
      - lamp
  lamp.db:
    container_name: ${MYSQL_VERSION:-mysql8}
    build:
      context: ./bin/${MYSQL_VERSION:-mysql8}
    ports:
      - ${MYSQL_PORT:-3306}:3306
    restart: always
    volumes:
      - ${DB_HOST:-./var/mysql}:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/custom-configs.cnf
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD:-root}
    networks:
      - lamp
  lamp.redis:
    container_name: redis
    image: redis
    ports:
      - "6379:6379"
    depends_on:
      - lamp.db
    profiles:
      - with-redis
    networks:
      - lamp
  lamp.pma:
    container_name: pma
    image: phpmyadmin/phpmyadmin
    restart: always
    ports:
      - ${PMA_PORT:-8080}:80
    environment:
      PMA_HOST: ${MYSQL_VERSION:-mysql8}
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${ROOT_PASSWORD:-root}
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD:-root}
    depends_on:
      - lamp.db
    profiles:
      - with-pma
    networks:
      - lamp
  lamp.mailhog:
    container_name: mailhog
    image: mailhog/mailhog
    ports:
      - "8025:8025"     # Web UI
      - "1025:1025"     # SMTP
    profiles:
      - with-mailhog
    networks:
      - lamp
networks:
  lamp:
    driver: bridge