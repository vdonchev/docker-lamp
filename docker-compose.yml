services:
  lamp.web:
    container_name: apache-${PHP_VERSION}
    build:
      context: ./bin/${PHP_VERSION}
    ports:
      - ${HTTP_PORT}:80
      - ${HTTPS_PORT}:443
    restart: always
    volumes:
      - ${WEB_HOST}:/var/www
      - ${WEB_STORAGE}:/home/storage
      - ./config/php/php.ini:/usr/local/etc/php/php.ini
      - ./config/apache/vhosts/generated:/etc/apache2/sites-enabled
      - ./config/apache/ssl:/etc/ssl/lamp
      - ./var/log/apache:/var/log/apache2
      - ./var/log/php:/var/log/php
      - ./scripts:/scripts
      - ./config:/config
      - ./entrypoint.sh:/entrypoint.sh
    entrypoint: ["/entrypoint.sh"]
    depends_on:
      - lamp.db
    networks:
      - lamp
  lamp.db:
    container_name: ${MYSQL_VERSION}
    build:
      context: ./bin/${MYSQL_VERSION}
    ports:
      - ${MYSQL_PORT}:3306
    restart: always
    volumes:
      - ${DB_HOST}:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/custom-configs.cnf
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
    networks:
      - lamp
  lamp.redis:
    container_name: redis
    image: redis
    ports:
      - "6379:6379"
    depends_on:
      - lamp.db
    profiles:
      - with-redis
    networks:
      - lamp
  lamp.pma:
    container_name: pma
    image: phpmyadmin/phpmyadmin
    restart: always
    ports:
      - ${PMA_PORT}:80
    environment:
      PMA_HOST: ${MYSQL_VERSION}
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${ROOT_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
    depends_on:
      - lamp.db
    profiles:
      - with-pma
    networks:
      - lamp
networks:
  lamp:
    driver: bridge