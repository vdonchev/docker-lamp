services:
  lamp.web:
    container_name: web
    build:
      context: .
      dockerfile: bin/php/${PHP_VERSION:-php84}/Dockerfile
    ports:
      - ${HTTP_PORT:-80}:80
      - ${HTTPS_PORT:-443}:443
    restart: always
    volumes:
      - ${WEB_ROOT:-./app}:/var/www
      - ./config/php/conf.d/php.ini:/usr/local/etc/php/conf.d/001-php.ini
      - ./config/apache/vhosts/generated:/etc/apache2/sites-enabled
      - ./config/apache/ssl:/etc/ssl/lamp
      - ./var/log/apache:/var/log/apache2
      - ./scripts:/scripts
      - ./config:/config
      - ./scripts/entrypoint/web.sh:/entrypoint.sh
    entrypoint: [ "/bin/bash", "-c", "/entrypoint.sh && exec apache2-foreground" ]
    depends_on:
      - lamp.db
    networks:
      - lamp
  lamp.db:
    container_name: db
    build:
      context: .
      dockerfile: bin/sql/${SQL_VERSION:-mysql84}/Dockerfile
    ports:
      - ${SQL_PORT:-3306}:3306
    restart: always
    volumes:
      - ${SQL_DATA_PATH:-./var}/db/${SQL_VERSION:-mysql84}:/var/lib/mysql
      - ./config/sql/my.cnf:/etc/mysql/conf.d/custom-configs.cnf
      - ./config/sql:/config/sql:ro
      - ./scripts/entrypoint/sql.sh:/docker-entrypoint-initdb.d/00-entrypoint.sh
    environment:
      MYSQL_ROOT_PASSWORD: ${SQL_ROOT_PWD:-root}
    entrypoint: [ "/bin/bash", "-c", "/docker-entrypoint-initdb.d/00-entrypoint.sh && exec docker-entrypoint.sh mysqld" ]
    networks:
      - lamp
  lamp.redis:
    container_name: redis
    image: redis
    ports:
      - "6379:6379"
    depends_on:
      - lamp.db
    profiles:
      - with-redis
    networks:
      - lamp
  lamp.pma:
    container_name: pma
    image: phpmyadmin/phpmyadmin
    restart: always
    ports:
      - ${PMA_PORT:-8080}:80
    environment:
      PMA_HOST: ${SQL_VERSION:-mysql84}
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${SQL_ROOT_PWD:-root}
      MYSQL_ROOT_PASSWORD: ${SQL_ROOT_PWD:-root}
    depends_on:
      - lamp.db
    profiles:
      - with-pma
    networks:
      - lamp
  lamp.mailhog:
    container_name: mailhog
    image: mailhog/mailhog
    ports:
      - "8025:8025"     # Web UI
      - "1025:1025"     # SMTP
    profiles:
      - with-mailhog
    networks:
      - lamp
networks:
  lamp:
    driver: bridge